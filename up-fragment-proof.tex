%!TEX root=ndma.tex
\begin{lemma}
\label{lem:tr-names}
For all edges in the configuration graph
\[
	(p_1,\rho_1) \tr{a} (p_2,\rho_2) 
\]
we have $\Im(\rho_2) \subseteq \Im(\rho_1) \cup \{ a \}$.
\end{lemma}
%
We write $(q_1,\rho_1) \Tr{v} (q_2,\rho_2)$ for the path in the configuration graph that spells $v$. Notice that, being $A$ deterministic, there can only be one such path. Given a sequence $P$ of transitions in $A$, we write $(q_1,\rho_1) \TrP{v}{P} (q_2,\rho_2)$ whenever $(q_1,\rho_1) \Tr{v} (q_2,\rho_2)$ and such path is induced by $P$.

Now we analyze properties of \emph{loops}, i.e.\ sequences of transitions whose initial and final state coincide. Consider a loop $L := p_0 \htr{l_0}{\sigma_0} p_1 \htr{l_1}{\sigma_1} \dots \htr{l_{n-1}}{\sigma_{n-1}} p_0$ in $A$. Let $\ul{i}$ denote $i \mod n$. Let $\widehat{\sigma}_i \colon \weight{p_\ul{i+1}} \pto \weight{p_i}$ be the partial functions given by
\[
	\widehat{\sigma}_i := \sigma_i \setminus \{ (x,y) \in \sigma_i \mid y = \star \} 
	\qquad (i=0,\dots,n-1)
\]
Intuitively, these are the maps between local names induced by $\sigma_i$ ignoring allocations. Let $\widehat{\sigma} \colon \weight{p_0} \pto \weight{p_0}$ be their composition $\widehat{\sigma}_0 \circ \widehat{\sigma}_1 \dots \circ \widehat{\sigma}_{n}$. We define the set $I$ as the greatest subset of $dom(\widehat{\sigma})$ such that
\[
	\widehat{\sigma}(I) = I \enspace ,
\]
i.e.\ $I$ contains those names that are just permuted along the loop. We denote by $T$ all the other names, namely 
\[
	T := \weight{p_0} \setminus I \enspace .
\]
%
The following lemma says that names assigned to registers in $T$ are eventually forgotten.


\begin{lemma}
\label{lem:rho-forget}
Given any $x \in T$, let $\{x_j\}_{j \in J_x}$ be the smallest sequence that satisfies the following conditions
\[
	x_0 = x \qquad
	x_{i+1} = \sigma_{\ul{i}}^{-1}(x_i)
\]
where $i+1 \in J_x$ only if $\sigma_{\ul{i}}^{-1}(x_i)$ is defined. Then $J_x$ has finite cardinality.

\end{lemma}
\begin{proof}
First of all, observe that this sequence is such that $x_{kn} \neq x_{k'n}$, for all $k,k' \geq 0$ such that $k \neq k'$. In fact, suppose there are $x_{kn} = x_{k'n}$, with $k < k'$. Then we should have $x_{kn-1} = x_{k'n-1}$, because $\sigma_{n}$ is injective. In general, $x_{kn-l} = x_{k'n-l}$, for $0 \leq l \leq kn$, therefore $x = x_0 = x_{(k'-k)n}$, which implies $x \in I$, against the hypothesis $x \in T$.\todo{Caratterizzare $I$ anche come l'insieme dei registri che prima o poi vengono mappati su loro stessi?}

Now, suppose that $J_x = \mathbb{N}$. Then we would have an infinite subsequence $\{x_{kn}\}_{k \in \mathbb{N}}$ of pairwise distinct names that belong to $\weight{p_0}$, but $\weight{q_0}$ is finite, a contradiction.
\qed
\end{proof}


\begin{lemma}
Given a path, there is always a word that follows that path.
\end{lemma}

\begin{lemma} Given any $\rho \colon \weight{p_0} \to \names$, there are $\theta,\epsilon,\zeta$ positive integers such that:
\label{lem:IT}
\begin{enumerate}

\item
%there is $\theta \geq 1$ such that, 
for all $v_1,\dots,v_\theta$ satisfying
\[
	(p_0,\rho) \TrP{v_1}{L} (p_0,\rho_1) \TrP{v_2}{L} \dots \TrP{v_{\theta}}{L} (p_0,\rho_\theta)
\]
we have $\restr{ \rho_\theta }{I} = \restr{ \rho }{I}$;
\label{idI}

\item %there is $\epsilon \geq 1$ such that, 
for all $\gamma \geq \epsilon$ there are $v_1,\dots,v_\gamma$ satisfying
\[
	(p_0,\rho) \TrP{v_1}{L} (p_0,\rho_1) \TrP{v_2}{L} \dots \TrP{v_\gamma}{L} (p_0,\rho_\gamma)
	\qquad 
	\Im(\rho_\gamma) \cap \rho(T) = \varnothing
\]
(Fix: $\rho_0(\weight{p_0}) \cap \rho_\gamma(T) = \varnothing$?)
\label{forgetT}
\item
%there is $\zeta$ such that, 
for any $\rho' \colon \weight{p_0} \to \names$ with $\Im(\rho) \cap \rho'(T) = \varnothing$, there are $v_1,\dots,v_\zeta$ satisfying
\[
	(p_0,\rho) \TrP{v_1}{L} (p_0,\rho_1) \TrP{v_2}{L} \dots \TrP{v_\zeta}{L} (p_0,\rho_\zeta)	
	\qquad
	\restr{\rho_\zeta}{T} = \restr{\rho'}{T}
\]
%and $\restr{\rho_\zeta}{T} = \restr{\rho'}{T}$.
\label{initT}
\end{enumerate}
\end{lemma}
\begin{proof}\hfill
\begin{enumerate}


\item The function $\restr{\widehat{\sigma}}{I}$ is a permutation, so by Langrange's theorem there is $\theta$ such that $\restr{\widehat{\sigma}}{I}^\theta = id_I$. The claim follows from $\restr{ \rho_\theta }{ I } =\restr{ \rho }{I} \circ \restr{ \widehat{\sigma}}{I}^{\theta} = \restr{ \rho }{I}$.


\item
Let $\mathcal{J}$ be
\[
	\mathcal{J} := \max \{ |J_x|\mid x \in T \} + 1 .
\]
This gives the number of transitions it takes to forget all the names stored in $T$. Let $\epsilon$ be $\lceil \frac{\mathcal{J}}{n} \rceil$. For any $\gamma \geq \epsilon$, we can choose $v_1,\dots,v_\gamma$ as any $\gamma$-tuple of words that are recognized by the loop and such that, whenever $l_j = \star$, then $(v_i)_j$ is different from $\Im(\rho)$ and all the previous symbols in $v_1,\dots,v_i$, for all $i=1,\dots,\gamma$ and $j=1,\dots,n$. Let us verify $\Im(\rho_\gamma) \cap \rho(T) = \varnothing$ separately on $I$ and $T$ (recall $I \cup T = \weight{p_0})$: we have $\rho_\gamma(T) \cap \rho(T) = \varnothing$, because all the names assigned to $T$ have been replaced by fresh ones; and we have $\rho_\gamma(I) = \rho(I)$, so $\rho_\gamma(I) \cap \rho(T) = \varnothing$.

\item For each name $x \in T$ define a tuple $(x,i,j)$ where $i$ is the index of the transition where $x$ is allocated and $j$ is the number of loop traversals needed to allocate it, i.e.\ $j$ is the smallest integer such that there are $x_{jn},\dots,x_1$ defined as follows
\[
	x_{jn} = x \qquad \sigma_\ul{k+1}(x_{k+1}) = x_k \qquad \sigma_i(x_1) = \star
\]
Let $X$ be the set of such tuples and let $\zeta := \max \{ j \mid (x,i,j) \in X \}$. Then we can construct $v_1,\dots,v_\zeta$ as follows
\[
	(v_k)_i :=
	\begin{cases}
		\text{$y$ fresh} & l_i = \star \land i \notin \pi_2(X) \\
		\rho'(x) & (x,i,\zeta - k + 1)\footnotemark \in X
		 \\
		\rho(l_0) & l_0 \neq \star \\
		\rho_{k-1}(l_i) & i > 0 , l_i \neq \star
	\end{cases}
\]

where by $y$ fresh we mean different from elements of $\Im(\rho) \cup \Im(\rho')$ and previous symbols in $v_1,\dots,v_{k}$.

The second case in the definition of $(v_k)_i$ is justified as follows. Suppose $\rho_{k,i}$ is the register assignment for the transition $(p_i,\rho_{k,i}) \tr{(v_k)_i} \dots$, then we have to show $(v_k)_i = \rho'(x) \notin \Im(\rho_{k,i})$. Suppose, by contradiction, that $\rho'(x) \in \Im(\rho_{k,i})$, then by \cref{lem:tr-names} $\rho'(x) \in \Im(\rho) \cup F$, where $F$ are all the fresh names allocated so far. But $F \cap \Im(\rho') = \varnothing$, by construction, so $\rho'(x) \in \Im(\rho)$, which implies $\rho'(T) \cap \Im(\rho) \neq \varnothing$, due to $x \in T$, against our hypothesis.

It is easy to see that $\rho_\zeta$ satisfies the statement by construction.

\end{enumerate}
\qed
\end{proof}


\newcommand{\rrho}{\hat \rho}
\begin{proposition}
\label{prop:loop}

For any $\hat{\rho} \colon \weight{p_0} \to \names$ there are $v_1,\dots,v_n$ such that
\[
	(p_0, \rrho) \TrP{v_1}{L} (p_0, \rrho_1) \TrP{v_2}{L} \cdots \TrP{v_n}{L} (p_0,\rrho) \enspace .
\]
\end{proposition}

\begin{proof}
We can take any path of the form
\[
	(p_0,\rrho) \TrP{v_1}{L} (p_0,\rrho_1) \TrP{v_2}{L} \cdots \TrP{v_{\gamma}}{L} (p_0,\rrho_\gamma) \TrP{v_{\gamma+1}}{L} \cdots \TrP{v_{\gamma + \zeta}}{L} (p_0,\rrho_{\gamma + 
	 \zeta})
\]
where the subpath from $(p_0,\rrho)$ to $(p_0,\rrho_\gamma)$ is given by \ref{forgetT} of \cref{lem:IT} and the remaining subpath is given by \ref{initT} of the same lemma, with $\rho = \rrho_\gamma$ and $\rho' = \rrho$. The only constraint about $\gamma$ is that there should be a positive integer $\lambda$ such that $\gamma + \zeta = \lambda \theta$, where $\theta$ is given by \ref{idI} of \cref{lem:IT}. Thanks to the lemma we have $\restr{\rrho_{\gamma + \zeta}}{T} = \restr{\rho}{T}$ and 
$\restr{\rrho_{\gamma + \zeta}}{I} = \restr{\rho}{I}$ which, together with $I \cup T = \weight{p_0}$, imply $\rrho_{\gamma + \zeta} = \rrho$.
\qed
\end{proof}


\begin{theorem}
Every non-empty language $\lang$ recognized by a HDMA $A$ has an ultimately periodic fragment.
\end{theorem}
\begin{proof}

Take any string $\alpha$ accepted by $A$ and let $I = Inf(q_0,\alpha)$, so $I \in \acc$. A path spelling $\alpha$ in the configuration graph must \todo{Spiegare meglio perch√® ``must''?} begin with
\[
	(q_0,\rho_0) \Tr{u} (q_1,\rho_1) \TrP{v}{P} (q_1,\rho_2)
\]
where $q_1 \in I$ and $(q_1,\rho_1) \TrP{v}{P} (q_2,\rho_2)$ is a path, induced by some sequence of transitions $P$ in $A$, that goes through all the states in $I$. Since $P$ is a loop, we can replace its induced path with a new one given by \cref{prop:loop} 
\[
	(q_0,\rho_0) \Tr{u} (q_1,\rho_1) \TrP{v_1}{P} \cdots \TrP{v_n}{P} (q_1,\rho_1) \enspace .
\]
This subpath can be traversed any number of times, so we have $u(v_1\dots v_n)^\omega \in \lang$.
\qed
\end{proof}
