%!TEX root=ndma.tex
%
%

\begin{figure}[t]
\begin{center}
 \begin{tikzpicture}[->,>=stealth',shorten >=1pt,auto,node distance=2.8cm,semithick,initial text={}]
  \tikzstyle{every state}=[minimum size=10ex]
  \tikzstyle{register}=	[circle,fill,draw,inner sep=0pt,minimum size=2pt]
	
  \node[state,initial] (q0) {$q_0$}; 
  \node[right=10ex of q0] {$\acc_\omega = \{ \{q_0 \}\}$ };

  \path (q0) edge [loop right]  node[inner sep=1pt] (star) {$\star$} (q0);
\end{tikzpicture}

\end{center}
\caption{Automaton $\autom_\omega$ for $\names^\omega$.}
\label{fig:nomega-automaton}
\end{figure}

\begin{figure}[t]
\begin{center}
 \begin{tikzpicture}[->,>=stealth',shorten >=1pt,auto,node distance=2.8cm,semithick,initial text={}]
  \tikzstyle{every state}=[minimum size=8ex]
  \tikzstyle{register}=	[circle,fill,draw,inner sep=0pt,minimum size=2pt]
	
  \node[state,initial] (q0) {$q_0$}; 
  \node[state,right of=q0] (q1) {};  
  \node (lab1) at (q1) {$q_1$};
  \node[register,label={[xshift=-2pt]right:$x$}] (reg) [above=1pt of lab1] {};
  \node [right=5ex of q1] {$\acc = \{ \{ q_0,q_1 \} \}$};


  \path (q0) edge [bend left]  node[inner sep=1pt] (star) {$\star$} (q1);
  \path (q1) edge [bend left] node {$x$} (q0);
  \path (reg) edge[densely dashed,bend right] (star);
\end{tikzpicture}
\end{center}
\caption{\label{fig:upwords} Automaton for the language of \cref{exa:session}.}
\end{figure}

\tbox{Sezione 4?}
{
Given a sequence $P$ of transitions in $A$, we write $(q_1,\rho_1) \TrP{v}{P} (q_2,\rho_2)$ whenever $(q_1,\rho_1) \Tr{v} (q_2,\rho_2)$ and such path is induced by $P$.
}
%
An \emph{ultimately periodic} word is a word of the form $uv^\omega$, with $u,v$ finite words. Given a $\omega$-regular language $\Lang$, let $UP(\Lang)$ be its ultimately periodic fragment, namely $\{ \alpha \in \Lang \mid \alpha = uv^\omega \land u,v \; \text{are finite} \}$. Then, for every two languages $\Lang_1$ and $\Lang_2$, $UP(\Lang_1) = UP(\Lang_2)$ implies $\Lang_1 = \Lang_2$ \cite{CalbrixNP93}, in words: $\omega$-regular languages are characterized by their ultimately periodic fragments.

In this section we aim to extend this result to the nominal setting. The preliminary result to establish, as in the classical case, is that every non-empty $\omega$-regular nominal language $\Lang$ contains at least one ultimately periodic word. For $\omega$-regular languages, this involves finding a loop through accepting states in the automaton and iterating it. In our case this is not enough, because it may not be possible to consume the same name in consecutive traversals of the same transition due to freshness. The first part of this section will be spent in showing that, given a loop in a \hdma{}, there always is a path induced by consecutive traversals of the loop, such that its initial and final configurations coincide. This implies that such path can be taken an arbitrary number of times.

We fix a loop (the specific \hdma{} is not relevant)
\[
	L \;:=\; p_0 \htr{l_0}{\sigma_0} p_1 \htr{l_1}{\sigma_1} \dots \htr{l_{n-1}}{\sigma_{n-1}} p_0
\]
We write $\ul{i}$ for $i \mod n$. Let $\widehat{\sigma}_i \colon \weight{p_\ul{i+1}} \pto \weight{p_i}$ be the partial maps telling the history of old registers and ignoring the new ones, formally
\[
	\widehat{\sigma}_i := \sigma_i \setminus \{ (x,y) \in \sigma_i \mid y = \star \} 
	\qquad (i=0,\dots,n-1)
\]
and let $\widehat{\sigma} \colon \weight{p_0} \pto \weight{p_0}$ be their composition $\widehat{\sigma}_0 \circ \widehat{\sigma}_1 \dots \circ \widehat{\sigma}_{n-1}$. We define the set $I$ as the greatest subset of $\dom(\widehat{\sigma})$ such that $ \widehat{\sigma}(I) = I$,
i.e.\ $I$ are the registers of $p_0$ that ``survive'' along $L$. We denote by $T$ all the other registers, namely $T := \weight{p_0} \setminus I$. These are registers whose content is eventually discarded (not necessarily within a single loop traversal), as the following lemma states.
%
%
\begin{lemma}
\label{lem:rho-forget}
Given any $x \in T$, let $\{x_j\}_{j \in J_x}$ be the smallest sequence that satisfies the following conditions:
$
	x_0 = x
$
and
$
	x_{j+1} = \sigma_{\ul{j}}^{-1}(x_j),
$
where $j+1 \in J_x$ only if $\sigma_{\ul{j}}^{-1}(x_i)$ is defined. Then $J_x$ has finite cardinality.
\end{lemma}
%
Now, consider any assignment $\rrho_0 \colon \weight{p_0} \to \names$. We give some lemmata about paths that start from $(p_0,\rrho_0)$ and are induced by consecutive traversals of $L$. The first one says that the assignment for $I$ given by $\rrho_0$ is always recovered after a fixed number of traversals of $L$, regardless of which symbols are consumed.
%
\begin{lemma} 
\label{lem:idI}
There is $\id \geq 1$ such that, for all $v_0,\dots,v_{\id-1}$ satisfying
\[
	(p_0,\rrho_0) \TrP{v_0}{L} (p_0,\rrho_1) \TrP{v_1}{L} \dots \TrP{v_{\id-1}}{L} (p_0,\rrho_\id)
\]
we have $\restr{ \rrho_\id }{I} = \restr{ \rrho_0 }{I}$.
\end{lemma}
%
The second one says that, after a minimum number of traversals of $L$, a configuration can be reached where the initial values of $T$, namely those assigned by $\rrho_0$, cannot be found in any of the registers.
%
\begin{lemma}
There is $\forg \geq 1$ such that, for all $\gamma \geq \forg$ ,there are $v_0,\dots,v_{\gamma-1}$ satisfying
\[
	(p_0,\rrho_0) \TrP{v_0}{L} (p_0,\rrho_1) \TrP{v_1}{L} \dots \TrP{v_{\gamma-1}}{L} (p_0,\rrho_\gamma)
	\qquad 
	\Im(\rrho_\gamma) \cap \rrho_0(T) = \varnothing \enspace .
\]
\label{lem:forgetT}
\end{lemma}
%
%
Finally, we give the dual of the previous lemma: if we start from a configuration where registers are not assigned values in $\rrho_0(T)$, then these values can be assigned back to $T$ in a fixed number of traversals of $L$, regardless of the initial assignment.

\begin{lemma}
There is $\ass \geq 1$ such that,
for any $\trho_0 \colon \weight{p_0} \to \names$ with $\Im(\trho_0) \cap \rrho_0(T) = \varnothing$, there are $v_0,\dots,v_{\ass-1}$ satisfying
\[
	(p_0,\trho_0) \TrP{v_0}{L} (p_0,\trho_1) \TrP{v_1}{L} \dots \TrP{v_{\ass-1}}{L} (p_0,\trho_\ass)	
	\qquad
	\restr{\trho_\ass}{T} = \restr{\rrho_0}{T} \enspace .
\]
\label{lem:initT}
\end{lemma}
%
\vspace{-4ex}
%
Finally, we combine the above lemmata. We construct a path where: (1) the values assigned to $T$ are forgotten and then recovered (2) the values assigned to $I$ are swapped, but the initial assignment is periodically regained. Therefore, the length of such path should allow (1) and (2) to ``synchronize'', so that the final assignment is again $\rrho_0$.

\begin{theorem}
\label{thm:loop}


There are $v_0,\dots,v_n$ such that
\[
	(p_0, \rrho_0) \TrP{v_0}{L} (p_0, \rrho_1) \TrP{v_1}{L} \cdots \TrP{v_n}{L} (p_0,\rrho_0) \enspace .
\]
\end{theorem}

\begin{proof}
We can take any path of the form
\[
	(p_0,\rrho_0) \TrP{v_0}{L} (p_0,\rrho_1) \TrP{v_1}{L} \cdots \TrP{v_{\gamma-1}}{L} (p_0,\rrho_\gamma) \TrP{v_{\gamma}}{L} \cdots \TrP{v_{\gamma + \ass - 1}}{L} (p_0,\rrho_{\gamma + 
	 \ass})
\]
where the part from $(p_0,\rrho_0)$ to $(p_0,\rrho_\gamma)$ is given by \cref{lem:forgetT} and the remaining subpath is given by \cref{lem:initT}, with $\trho_0 = \rrho_\gamma$. The only constraint about $\gamma$ is that there should be a positive integer $\lambda$ such that $\gamma + \ass = \lambda \id$, where $\id$ is given by \cref{lem:idI}. The claim follows from $\restr{\rrho_{\gamma + \ass}}{T} = \restr{\rrho_0}{T}$ and 
$\restr{\rrho_{\gamma + \ass}}{I} = \restr{\rrho_0}{I}$ which, together with $I \cup T = \weight{p_0}$, imply $\rrho_{\gamma + \ass} = \rrho_0$.
\qed
\end{proof}
%

\begin{figure}[t]
\begin{center}
 \begin{tikzpicture}[->,>=stealth',shorten >=1pt,auto,node distance=2.8cm,semithick,initial text={}]
  \tikzstyle{every state}=[minimum size=10ex]
  \tikzstyle{register}=	[circle,fill,draw,inner sep=0pt,minimum size=2pt]
	
  \node[register,label={[shift={(2pt,-2pt)}]above:$x_0$}] (reg00) {};
  \node[register,label={[shift={(2pt,-2pt)}]above:$y_0$}] (reg01) [right=10pt of reg00] {};
  \node[register,label={[shift={(2pt,-2pt)}]above:$z_0$}] (reg02) [right=10pt of reg01] {};

  \node[register,label={[shift={(2pt,-2pt)}]above:$x_1$}] (reg10) [right=50pt of reg02] {};
  \node[register,label={[shift={(2pt,-2pt)}]above:$y_1$}] (reg11) [right=10pt of reg10] {};
  \node[register,label={[shift={(2pt,-2pt)}]above:$z_1$}] (reg12) [right=10pt of reg11] {};

  \node[register,label={[shift={(2pt,-2pt)}]above:$y_2$}] (reg21) at ($(reg02)!0.5!(reg10)$) [yshift=-15ex] {};

  \node[register,label={[shift={(2pt,-2pt)}]above:$x_2$}] (reg20) [left=10pt of reg21] {};
  \node[register,label={[shift={(2pt,-2pt)}]above:$z_2$}] (reg22) [right=10pt of reg21] {};



  \node[state,initial,fit={(reg00) (reg01) (reg02)},inner sep=2ex] (q0) {};
  \node[above left=-1ex of q0] (lab0) {$q_0$}; 
  \node[state,fit={(reg10) (reg11) (reg12)},inner sep=2ex] (q1) {};
  \node[above right=-1ex of q1] (lab1) {$q_1$}; 
  \node[state,fit={(reg20) (reg21) (reg22)},inner sep=2ex] (q2) {};
  \node[below=1pt of q2] (lab2) {$q_2$}; 

  \path (q0) edge [bend left] node {$z_0$} (q1);
  \path (q1) edge [bend left]  node[inner sep=1pt] (star) {$\star$} (q2);
  \path (q2) edge [bend left] node {$x_2$} (q0);
	
  \path (reg10) edge[densely dashed,out=90,in=90,looseness=2,shorten >=7pt,shorten <=8pt] (reg01);
  \path (reg11) edge[densely dashed,out=90,in=90,looseness=2,shorten >=7pt,shorten <=8pt] (reg00);
  \path (reg12) edge[densely dashed,out=90,in=90,looseness=2,shorten >=7pt,shorten <=8pt] (reg02);

  \path (reg20) edge[densely dashed,shorten <=8pt] (reg10);
  \path (reg21) edge[densely dashed,shorten <=8pt] (reg11);
  \path (reg22) edge[bend right,densely dashed] (star);

  \path (reg20) edge[densely dashed,shorten <=5pt] (reg00);
  \path (reg21) edge[densely dashed,shorten <=5pt] (reg01);
  \path (reg22) edge[densely dashed,shorten <=5pt] (reg02);

\end{tikzpicture}

\end{center}
\caption{\label{fig:upwords-ex} An example automaton. Some transitions are not shown: they are all assumed to end up in a sink state without registers.}
\end{figure}

\begin{example} We justify the above construction on the automaton in \cref{fig:upwords-ex}, with initial assignment $\rho_0(x_0) = a$,$\rho_0(y_0) = b$ and $\rho_0(z_0) = c$. We omit the accepting set, as it is not relevant. Consider the loop $L$ formed by all the depicted transitions.
We have $I = \{x_0,y_0\}$ and $T = \{z_0\}$. Consider the path
\begin{align*}
	(q_0,[\subs{a}{x_0},\subs{b}{y_0},\subs{c}{z_0}]) \tr{c} (q_1,[\subs{b}{x_1},\subs{a}{y_1},\subs{c}{z_1}]) &\tr{d} (q_2,[\subs{b}{x_2},\subs{a}{y_2},\subs{d}{z_2}]) \\
	&\tr{b} (q_0,[\subs{b}{x_0},\subs{a}{y_0},\subs{d}{z_0}])
\end{align*}
where $d \neq a,b,c$. Notice that the values of $x_0$ and $y_0$ get swapped according to the permutation $(a \; b)$, and $d$ is assigned to $z_0$. Our aim is to recover $\rho_0$ again. According to \cref{lem:idI}, $x_0$ and $y_0$ get their assignment back in $\theta = 2$ traversals of $L$ (in fact $(a\; b)^2 = (a\; b)$). As for $z_0$, its assignment is established in the second transition, but $c$ should not have been assigned to any register of $q_1$ in order for it to be consumed during this transition. This is where \cref{lem:forgetT} comes into play: it says that in at least $\epsilon = 1$ traversals of $L$ the name $c$ is discarded. This is exactly what happens in the path shown above. Then we can assign $c$ to $z_0$ in another $\zeta = 1$ traversal of $L$, according to \cref{lem:initT}. Since $\epsilon + \zeta  = \theta = 2$, traversing $L$ twice is enough. For instance, we can take the path spelling $cdbdca$.
\end{example}


Finally we have the main results.
%
\begin{theorem}
\label{thm:up-fragment}
Every non-empty $\omega$-regular nominal language $\Lang$ has an ultimately periodic fragment.
\end{theorem}
\begin{proof}
Let $\autom$ be the automaton for $\Lang$. Take any $\alpha \in \Lang$ and let $I = \Inf(r^\alpha)$ (recall $r^\alpha$ is the run for $\alpha$ in $\autom$), so $I \in \acc$. A path spelling $\alpha$ in the configuration graph of $A$ must \todo{Spiegare meglio perchè ``must''?} begin with
\[
	(q_0,\rho_0) \Tr{u} (q_1,\rho_1) \TrP{v}{P} (q_1,\rho_2)
\]
where $q_1 \in I$ and $(q_1,\rho_1) \TrP{v}{P} (q_2,\rho_2)$ is such that $P$ goes through all the states in $I$. Since $P$ is a loop, we can replace its induced path with a new one given by \cref{thm:loop} 
\[
	(q_0,\rho_0) \Tr{u} (q_1,\rho_1) \TrP{v_0}{P} \cdots \TrP{v_n}{P} (q_1,\rho_1) \enspace .
\]
This subpath can be traversed any number of times, so we have $u(v_0\dots v_n)^\omega \in \Lang$.
\qed
\end{proof}

\begin{theorem}
Let $\Lang_1,\Lang_2$ be $\omega$-regular nominal languages. Then $UP(\Lang_1) = UP(\Lang_2)$ implies $\Lang_1 = \Lang_2$.
\end{theorem}
\begin{proof}
Consider the language $(\Lang_1 \cup \Lang_2) \setminus (\Lang_2 \cap \Lang_2)$. By \cref{thm:bool-closure}, this is a $\omega$-regular nominal language. Suppose it is not empty, i.e.\ $\Lang_1 \neq \Lang_2$. Then, by \cref{thm:up-fragment}, it must contain at least one ultimately periodic word, so also $UP(\Lang_1) \neq UP(\Lang_2)$, a contradiction.
\end{proof}
