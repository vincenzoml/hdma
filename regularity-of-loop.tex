%!TEX root=ndma.tex
\newcommand{\eq}[1]{#1}

We call \emph{transition structure} a \hdma{} without acceptance condition, namely a tuple $\tstr = (Q,\weight{-},q_0,\rho_0,\trarrow)$. Given a relation $R$, we denote by $R^*$ its symmetric, transitive and reflexive closure.

We now define the \emph{synchronized product} of transition structures.
Some notation: given two disjoint sets of names $S_1,S_2 \subseteq \names$,we write $Eq(S_1,S_2)$ for the set of all equivalence relations $R \subseteq (S_1 \cup S_2) \times (S_1 \cup S_2)$ induced by equations of the form $x_1 \eq{R} x_2$, for $x_i \in S_i$

Given two \hdmas{} $\autom_i = (Q_i,\weight{-}_i,q_0^i,\rho_0^i,\trarrow_i,\acc_i)$, $i=1,2$, we now define their \emph{synchronized product} $\autom_1 \syncp \autom_2$. We assume $\weight{q_1}_1 \cap \weight{q_2}_2 = \varnothing$, for all $q_i \in Q_i$.\todo{Dare lemma in cui si dice che posso sempre rinominare i registri?} Some notation: given two disjoint sets of names $S_1,S_2 \subseteq \names$,we write $Eq(S_1,S_2)$ for the set of all equivalence relations $R \subseteq (S_1 \cup S_2) \times (S_1 \cup S_2)$ induced by equations of the form $x_1 \eq{R} x_2$, for $x_i \in S_i$. 

\paragraph{Alternativa.} $R$ are equations, $R^*$ is the associated equivalence relation. $R \circ \sigma$ to 

\begin{definition}[Synchronized product of \hdmas]
\label{def:syncp}
 $\autom_1 \syncp \autom_2$ is an automaton $(Q,\weight{-},q_0,\rho_0,\trarrow_i,\acc)$ defined as follows
\begin{itemize}
	\item $Q := \bigcup_{q_1 \in Q_1,q_2 \in Q_2} \{(q_1,q_2)\} \times Eq(\weight{q_1}_1,\weight{q_2}_2)$;
	%
	\item $\weight{(q_1,q_2,R)} := (\weight{q_1}_1 \cup \weight{q_2}_2)_{/R}$, for $(q_1,q_2,R) \in Q$;
	%
	\item $q_0 := (q_0^1,q_0^2,R_0)$, where $R_0$ is given by
	\[
		\inferrule
		{ \rho_0^1(x_1) = \rho_0^2(x_2) \\ x_1 \in \weight{q_0^1},x_2 \in \weight{q_0^2}}
		{ x_1 \eq{R_0} x_2 }
	\]
	\item $\rho_0([x]_{R_0}) = \rho_0^i (x)$ whenever $x \in \weight{q_0^i}_i$, $i \in \{1,2\}$; 
	%(well-defined by definition of $R_0$);
	%
	\item $(q_1,q_2,R) \htr{l}{\sigma} (q_1',q_2',R')$ if and only if there are $q_i \htrind{l_i}{\sigma_i}{i} q_i'$, $i=1,2$, such that $\sigma([x]_{R'}) = [\sigma_i(x)]_R$, for all $x \in \weight{q_i'}$ with $\sigma_i^{-1}(x) \neq \star$, 
	%for $i \in \{1,2\}$ $i=1,2$ 
	%$q_2 \htrind{l_2}{\sigma_2}{2} q_2'$, 
	and one of the following holds: 
	\begin{itemize}
		%	
		\item if $l_1,l_2 \in \names$ then $l_1 =_R l_2$, $l = [l_1]_R$, and $R'$ is the smallest equivalence relation generated by
		\[
%			\inferrule*[left=Eq]
%			{ x_1 \eq{R} x_2 \\ x_1 \in \Im(\sigma_1),x_2 \in \Im(\sigma_2)}
%			{ \sigma_1^{-1}(x_1) \eq{R'} \sigma_2^{-1}(x_2) }
%			%
%			\qquad
			%
			\inferrule*[left=Eq]
			{ \sigma_1(x_1) \eq{R} \sigma_2(x_2) }
			{ x_1 \eq{R'} x_2 }
		\]
		%
		\item if $l_1 \in \names$ and $l_2 = \star $ then $l = [l_1]_R$, $[l_1]_R = \{l_1\}$ and $R'$ is generated by \textsc{Eq} and
		\[
			\inferrule
			{ l_1 \in \Im(\sigma_1) }
			{ \sigma_1^{-1}(l_1) \eq{R'} \sigma_2^{-1}(\star) }
		\]
		and $\sigma([\sigma_2^{-1}(\star)]_{R'}) = [l_1]_R$.
		\item if $l_1,l_2 = \star$ then $l=\star$ and $R'$ is generated by \textsc{Eq} and
		\[
			\sigma_1^{-1}(\star) \eq{R'} \sigma_2^{-1}(\star)
		\]
		and $\sigma([\sigma_1^{-1}(\star)]_{R'}) = \star$.
	\end{itemize}
	%
	\item $\acc := ????$
	%and $\sigma([x]_{R'}) = [\sigma_i(x)]_R$ whenever $x \in \weight{q_i'}$, for $i \in \{1,2\}$.
%		\[
%			\sigma([x]_{R'}) = 
%			\begin{cases}
%				[\sigma_1(x)]_R & x \in \weight{q_1'} \\
%				[\sigma_2(x)]_R & x \in \weight{q_2'}
%			\end{cases}
%		\]
\end{itemize}
\end{definition}

\begin{definition}[Synchronized product of transition structures]
\label{def:syncp}
Given two transition structures $\tstr_1,\tstr_2$, their \emph{synchronized product} $\tstr_1 \syncp \tstr_2$ is $(Q,\weight{-},q_0,\rho_0,\trarrow)$, defined as follows:
\begin{itemize}
	\item $Q := \bigcup_{q_1 \in Q_1,q_2 \in Q_2} \{(q_1,q_2)\} \times \Pow(\weight{q_1}_1 \times \weight{q_2}_2)$;
	%
	\item $\weight{(q_1,q_2,R)} := (\weight{q_1}_1 \cup \weight{q_2}_2)_{/R^*}$, for $(q_1,q_2,R) \in Q$;
	%
	\item $q_0 := (q_0^1,q_0^2,R_0)$, where $R_0:= \{ (x_1,x_2) \in \weight{q_0^1}_1 \times \weight{q_0^2}_2 \mid \rho_0^1(x_1) = \rho_0^2(x_2) \}$ 
	%is given by
%	\[
%		\inferrule
%		{ \rho_0^1(x_1) = \rho_0^2(x_2) \\ x_1 \in \weight{q_0^1},x_2 \in \weight{q_0^2}}
%		{ x_1 \eq{R_0} x_2 }
%	\]
	\item $\rho_0([x]_{R_0^*}) = \rho_0^i (x)$ whenever $x \in \weight{q_0^i}_i$, $i \in \{1,2\}$; 
	%(well-defined by definition of $R_0$);
	%
	\item transitions are generated by the following rules
	%$(q_1,q_2,R) \htr{l}{\sigma} (q_1',q_2',R')$ if and only if there are $q_i \htrind{l_i}{\sigma_i}{i} q_i'$, $i=1,2$ and:
%	\begin{itemize}
%		\item 
%		\item 
		\begin{mathpar}
			\inferrule[(Reg)]
			{ q_1 \htrind{l_1}{\sigma_1}{1} q_1' \\
			q_2 \htrind{l_2}{\sigma_2}{2} q_2'
			\\\\
			l_i \in \names \\ [l_i]_{R^*} = \{l_1,l_2\} \cap \names}
			{ (q_1,q_2,R) \xrightarrow
			[\sigma]
			{{[l_i]_{R^*}}}
			(q_1',q_2',S) } 
			%}
			\and
			\inferrule[(Alloc)]
			{ q_1 \htrind{l_1}{\sigma_1}{1} q_1' \\ q_2 \htrind{l_2}{\sigma_2}{2} q_2' \\ l_1,l_2 = \star} 
			{ (q_1,q_2,R) \htr{\star}{\sigma'} (q_1',q_2',S) }
%			\inferrule
%			{ 
%				q_1 \htrind{a_1}{\sigma_1}{1} q_1' \\
%				q_2 \htrind{a_2}{\sigma_2}{2} q_2' \\
%				a_1 R a_2 }
%			{
%				(q_1,q_2,R) \xrightarrow[\sigma]{[a_1]_{R^*}} (q_1',q_2',S)
%			}
%			\\
%			\inferrule
%			{
%				q_1 \htrind{a}{\sigma_1}{1} q_1' \\
%				q_2 \htrind{\star}{\sigma_2}{2} q_2' \\
%				[a]_{R^*} = \{a\}
%			}
%			{
%				(q_1,q_2,R) \xrightarrow[\sigma\sub{[a]_{R^*}}{[\sigma_2^{-1}(\star)]_{S^*}}]{\{a\}} (q_1',q_2',S) 
%			}
%			\and
%			\inferrule
%			{
%				q_1 \htrind{\star}{\sigma_1}{1} q_1' \\
%				q_2 \htrind{\star}{\sigma_2}{2} q_2'
%			}
%			{
%				(q_1,q_2,R) \xrightarrow[\sigma\sub{\star}{[\widehat{\sigma}^{-1}(\star)]_{S^*}}]{[a]_{R^*}} (q_1',q_2',S)	
%			}
		\end{mathpar}
	%where 
	%(let $l_i$ be the label of the transition from $q_i$)
	\begin{align*}
		S &:= \sigma_2^{-1} \circ R \cup \{(l_1,l_2)\} \circ \sigma_1 \\
%		\sigma([x]_{S^*}) &:= [\sigma_i(x)]_{R^*} \;   \text{whenever} \; x \in \weight{q'_i}_i \land \sigma_i(x) \neq \star \\
%		\widehat{\sigma}^{-1}(x) &:=
%		{
%		\begin{cases}
%			\sigma_1^{-1}(x) & x \in \Im(\sigma_1) \\\sigma_2^{-1}(x) & \text{otherwise}
%		\end{cases}
%		}
%	\end{align*}
%	\todo[inline]{Vedere se si pu√≤ compattare le prime due regole: solo $\sigma$ come history inferita. Si potrebbe fare una sola $\sigma$ per tutto: conviene? Meglio fare due regole e due $\sigma$.}
%	\begin{align*}
		\sigma([x]_{S^*}) &:= 
		\begin{cases}
			[\sigma_i(x)]_{R^*} & x \in \weight{q'_i}_i \land \sigma_i(x) \neq \star \\
			[l_{3-i}]_{R^*} & x \in \weight{q'_i}_i \land \sigma_i(x) = \star 
			%\land l_{3-i} \neq \star \\
			%\star & 
		\end{cases}
		\\
		\sigma'([x]_{S^*}) &:= 
		\begin{cases}
			[\sigma_i(x)]_{R^*} & x \in \weight{q'_i}_i \land \sigma_i(x) \neq \star \\
			\star & x \in \weight{q'_i}_i \land \sigma_i(x) = \star 
			%\land l_{3-i} \neq \star \\
			%\star & 
		\end{cases}
	\end{align*}
	% \qquad
%		eq_R(x) := 
%		\begin{cases}
%			[x]_{R^*} & x \neq \star \\
%			\star & \text{otherwise}
%		\end{cases}
%	\]
%	\begin{align*}
%		\sigma([x]_{R'}) &:=
%		\begin{cases}
%			[\sigma_i(x)]_R 
%			& x \in \weight{q'_i}_i \land \sigma_i(x) \neq \star \\
%			eq_R(\sigma_{3-i}^{-1}(\star))
%			
%			eq_R(l_{3-i})
%			& x \in \weight{q_i'}_i \land \sigma_i(x) = \star %\land \star \in \Im(\sigma_{3-i})
%		\end{cases}
%		\\
%		eq_R(x) &:= 
%		\begin{cases}
%			[x]_{R^*} & x \neq \star \\
%			\star & \text{otherwise}
%		\end{cases}		
%	\end{align*}
\end{itemize}
\end{definition}

The intuition is that the synchronized product is made of transitions that both structures can do. However, there is an overhead to handle registers. When we compute the synchronized transitions from two states $q_1 \in Q_1$ and $q_2 \in Q_2$, we cannot simply make the union of registers, because the content of some registers of $q_1$ and $q_2$ may be the same, but register assignments are injective. The solution is identifying register that contain the same values and keep track of such identifications within states: $R$ in $(q_1,q_2,R)$ has exactly this purpose. Registers of such state are defined to be equivalence classes of the set of registers of both $q_1$ and $q_2$ under the relation induced by $R$. Notice that the state space $Q$ contains some inconsistent states, for instance those where two registers of $q_1$ are identified with the same register of $q_2$, hence among themselves by transitivity, but the definition of transitions ensures that these are never reached. The initial state $q_0$ contains both initial states of $\tstr_1$ and $\tstr_2$, and its registers must be initialized according to $\rho_0$: registers that are assigned the same value are identified. 

Transitions of $(q_1,q_2,R)$ are derived from those of $q_1$ and $q_2$ as follows. If either $q_1$ or $q_2$ can do a transition labelled with a register $l_i$, and such register is at most identified in $R$ with the one on the other transition, if any, then we then we synthesize a unique transition labelled with the set of register identified with $l_i$. The intuition is that either both $q_1$ and $q_2$ store the same name, so the   or one of them, say $q_1$, is allocating a name that $q_2$ already has, so the newly allocated register in $q_1$, if any, should coincide with the one in $q_2$ that stores that name.

%In case the other label is $\star$, this means that 

then 
transitions labelled with registers $a_1$ and $a_2$, and these registers represent the same register in the composite state, then we synthesize a unique transition labelled with such register. The history $\sigma$ is just the extension of $\sigma_1$ and $\sigma_2$ to equivalence classes. It is easy to see that this function is well-defined by how we constructed $S$.
%: elements of the same equivalence class are mapped to the same equivalence class
%is obtained

If one of the original labels is $\star$ and the other one is a register $a$, then we can derive a transition labelled with the singleton equivalence class $\{a\}$, provided that $a$ is not already identified with other registers. This condition avoids inconsistent identifications in $S$. The intuition is that $q_1$ already knows the name that $q_2$ is allocating, so the register of $q_2'$ it is assigned to should be identified with the counterpart of $a$ in $q_1'$, if any. The history is as the previous case, but it not well-defined, because 
 there may be $x \in \weight{q_2'}_2$ such that $\sigma_2(x) = \star$: by definition, $\sigma$ is not defined
 $\sigma_2^{-1}(\star = \star$, 
 we must also handle the case $[\sigma]_{R*}$, which is 

If both labels are $\star$, then 

then the fresh name 
what is new to $q_2$ is already known to $q_1$, provided that $R$ does not identify the register being read with any other register (this avoids inconsistent identifications in $S$);
% register can be read; if one of them can do $\star$.

$S$ contains $(y_1,y_2)$ whenever $y_1$ is mapped by $\sigma_1$ to some $x_1$, related by $R$ to some $x_2$, and $x_2$ is the image of $y_2$ via $\sigma_2$. We add an identification between labels to $R$ because this allows us to handle the case when at least one of them is $\star$. However, if $\star$ is not in the image of the corresponding $\sigma$, this addition has no effect.

% that can never be reached, for instance those where two registers $q_1$  


%\begin{mathpar}
%	\inferrule
%	{ \sigma_1(x_1) \eq{R} \sigma_2(x_2) }
%	{ x_1 \eq{R'} x_2 }
%	\and
%	\inferrule
%	{l_i \in \Im(\sigma_i),i=1,2 } 
%	{ \sigma_1^{-1}(l_1) \eq{R'} \sigma_2^{-1}(l_2) }
%\end{mathpar}

\begin{definition}
A state $(q_1,q_2,R)$ of $\tstr_1 \times \tstr_2$ is \emph{well-formed} whenever, for each $(x_1,y_1),(x_2,y_2) \in R$, $(x_1,y_1) \neq (x_2,y_2)$ implies $x_1 \neq x_2$ and $y_1 \neq y_2$. Or, equivalently, each $[x]_{R^*} \in \weight{(q_1,q_2,R)}$ has cardinality at most two.
\end{definition}

\begin{proposition}
Given $(q_1,q_2,R) \htr{l}{\sigma} (q_1',q_2',S)$, if $(q_1,q_2,R)$ is well-formed then so is $(q_1',q_2',S)$.
\end{proposition}
\begin{proof}
$S$ is the composition of three well-formed relations, so it is well-formed itself. Injective functions, seen as relations, are always well-formed, so $\sigma_2^{-1}$ and $\sigma_1$ are well-formed.
\end{proof}

\begin{proposition}
Let $((q_1,q_2,R),\rho) \tr{a} ((q_1',q_2',R'),\rho')$ be an edge in the configuration graph of $\autom_1 \syncp \autom_2$, and let $\rho_i = \lambda x \in \weight{q_i}.\rho([x]_R)$, for $i=1,2$. Then $(q_i,\rho_i) \trind{a}{i} (q_i',\rho_i')$ is and edge in the configuration graph of $\autom_i$ with $\rho'_i = \lambda x \in \weight{q_i}.\rho'([x]_{R'})$.
%, for $i=1,2$.
%and $(q_2,\rho_2) \trind{a}{2} (q_2',\rho_2')$ are edges in the configuration graphs of $\autom_1$ and $\autom_2$, respectively, with $\rho'_i = \lambda x \in \weight{q_i}.\rho'([x]_{R'})$.
\end{proposition}
\begin{proof}
We proceed by cases on the transition $((q_1,q_2,R),\rho) \htr{l}{\sigma} ((q_1',q_2',R'),\rho')$ in $\autom_1 \syncp \autom_2$ that induces $((q_1,q_2,R),\rho) \tr{a} ((q_1',q_2',R'),\rho')$:
\begin{description}
	\item[Case $l \in \names$:] Then there are two transitions $q_i \htrind{l_i}{\sigma_i}{i} q_i'$, $i=1,2$, according to \cref{def:syncp}.
	% and $q_2 \htrind{l_2}{\sigma_2}{2} q_2'$ according to \cref{def:syncp}. 
	We have two cases:
	\begin{itemize}
	\item $l_1,l_2 \in \names$.
	Since $l_1 \eq{R} l_2$, we have $\rho_i(l_i) = \rho([l_i]_R) = \rho([l]_R) = a$, so these transitions induce two edges $(q_i,\rho_i) \trind{a}{i} (q_i',\rho_i')$.
	% and $(q_2,\rho_2) \trind{a}{2} (q_2',\rho_2')$.
	Given $x \in \weight{q_i'}$, the following chain of equations, all expanding the definition of the involved function, proves the last part of the statement
	\begin{align*}
		\rho'_i(x) &= \rho_i (\sigma_i (x) ) \\
		&= \rho([\sigma_i(x)]_R) \\
		%&& \text{(by definition of $\rho_i$)}\\
		&= \rho(\sigma([x]_{R'})) \\
		%&& \text{(by definition of $\sigma$)}\\
		&= \rho'([x]_{R'}) 
		%&& \text{(by definition of $\rho'$)}
	\end{align*}
	
	\item if $l_1 \in \names,l_2 = \star$ then $\rho_1(l_1) = \rho([l_1]_R) = a$ and $a \notin \Im(\rho_2)$. In fact, %$a \in \Im(\rho_2)$ only 
	if there was $l_2 \in \weight{q_2}$ such that $\rho_2(l_2) = a$, then $\rho([l_2]_R) = a = \rho([l_1]_R)$, by definition of $\rho$, which implies $[l_1]_R = [l_2]_R$, by injectivity of $\rho$, i.e. $\{l_1,l_2\} \in [l_1]_R$, against the hypothesis $[l_1]_R = \{l_1\}$. So we have $(q_i,\rho_i) \trind{a}{i} (q_i',\rho_i')$, $i=1,2$, and the same equations as the previous case hold; we just have to check the value of $\rho_2'$ on $x = \sigma_2^{-1}(\star)$:
	\begin{align*}
		\rho'_2(x) &= (\rho_2 \circ \sigma_2)\sub{a}{\sigma_2^{-1}(\star)}(x) \\
		&= a \\
		&= \rho([l_1]_R) \\
		&= (\rho \circ \sigma)([x]_{R'}) \\
		& = \rho'([x]_{R'})
	\end{align*}	
	All the equations just apply the definitions of the involved functions.
	%so $\rho([l_1]_R) = \rho([l_2]_R)$, by injectivity of $\rho$.
	%, but this means $, because $[l_1]_R = \{l_1\}$
	\end{itemize}

	\item[Case $l = \star$:] 
	Then we have $q_i \htrind{\star}{\sigma_i}{i} q_i'$, and for $i=1,2$% and $x = \sigma_i^{-1}(\star)$
	\begin{align*}
		\rho'_i(\sigma_i^{-1}(\star)) &= (\rho_i \circ \sigma_i)\sub{a}{\sigma_i^{-1}(\star)}(\sigma_i^{-1}(\star)) \\
		&= a \\
		&= (\rho \circ \sigma) \sub{a}{\sigma^{-1}(\star)}(\sigma^{-1}(\star)) \\
		&= (\rho \circ \sigma) \sub{a}{[\sigma_1^{-1}(\star)]_{R'}}([\sigma_1^{-1}(\star)]_{R'}) \\
		%&& \text{(by $[\sigma_1^{-1}(\star)]_{R'} = [\sigma_i(\star)^{-1}]_{R'}$)} \\
		& = (\rho \circ \sigma) \sub{a}{[\sigma_i^{-1}(\star)]_{R'}}([\sigma_i^{-1}(\star)]_{R'}) && \text{(definition of $R'$)} \\
		&= \rho'([\sigma_i(\star)^{-1}]_{R'})
	\end{align*}
	
	%Then there are $q_i \htrind{l_i}{\sigma_i}{i} q_i'$, $i=1,2$. We have two cases:
%	\begin{itemize}
%		\item 
%	\end{itemize}
\end{description} 
\end{proof}

\begin{corollary}
Given a path $((q_0^1,q_0^2,R_0),\rho_0) \tr{a_0} \dots \tr{a_{n-1}} ((q_n^1,q_n^2,R_n),\rho_n)$ in the configuration graph of $\autom_1 \syncp \autom_2$, there is a path $(q_0^i,\rho_0^i) \tr{a_0} \dots \tr{a_{n-1}} (q_n^i,\rho_n^i)$ in the configuration graph of $\autom_i$ with $\rho_n^i = \lambda x \in \weight{q_n^i}.\rho_n([x]_{R_n})$, for $i=1,2$.
\end{corollary}

\begin{proposition}
$\syncp$ is associative.
\end{proposition}

\begin{proof}
Unfortunately this is not true: states in $(\autom_1 \syncp \autom_2 ) \syncp \autom_3$ are different that $\autom_1 \syncp (\autom_2 \syncp \autom_3)$, but are isomorphic, because equality is transitive. Maybe my representation is too concrete?
\end{proof}
